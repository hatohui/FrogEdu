# Technical Specification: Exam Flow (Manual Creation & Management)

**Feature ID:** 02-EXAM-FLOW  
**Status:** ğŸŸ¡ Implementation Ready  
**Priority:** P0 (Core Feature)  
**Estimated Effort:** 3-5 days  
**Sprint:** Sprint 1  
**Related Specs:** [backend-spec.md](../backend-spec.md), [prompt-spec.md](../prompt-spec.md)

---

## ğŸ“‹ Table of Contents

1. [Overview](#overview)
2. [User Stories & Acceptance Criteria](#user-stories--acceptance-criteria)
3. [Architecture & Design](#architecture--design)
4. [Frontend Implementation](#frontend-implementation)
5. [Backend Verification](#backend-verification)
6. [Data Flow & State Management](#data-flow--state-management)
7. [Validation & Error Handling](#validation--error-handling)
8. [Testing Strategy](#testing-strategy)
9. [Implementation Checklist](#implementation-checklist)

---

## Overview

### Business Context

Teachers need a streamlined workflow to manually create, manage, and organize exams. The exam creation process follows a structured flow:

1. **Exam Metadata Setup** - Define basic exam information (name, subject, grade, topic)
2. **Matrix Definition (Optional)** - Create a test specification matrix following Bloom's taxonomy
3. **Question Management** - Add/edit/review questions in a question bank
4. **Exam Publishing** - Finalize and activate exams for student access

### Key Principles

- **Simplified Exam Model:** Exams contain only essential printable information (no duration, scheduling, access codes)
- **Question Bank Architecture:** Questions are reusable assets independent of exams
- **Progressive Enhancement:** Matrix creation is optional but encouraged for pedagogical rigor
- **Draft-to-Published Workflow:** Exams start as drafts and can be published when ready

### Technical Scope

**In Scope:**

- âœ… Exam CRUD operations (Create, Read, Update, Delete)
- âœ… Subject/Topic selection with grade filtering
- âœ… Optional exam matrix builder following Bloom's taxonomy
- âœ… Question bank management (create, edit, delete questions)
- âœ… Question-to-exam association (add/remove questions)
- âœ… Draft/Published status management
- âœ… Responsive UI with Shadcn components

**Out of Scope:**

- âŒ AI-generated exam creation (separate feature)
- âŒ Student exam-taking interface (separate feature)
- âŒ Auto-grading and scoring (separate feature)
- âŒ Exam scheduling and time limits (removed from simplified model)
- âŒ Access codes and password protection (removed from simplified model)

---

## User Stories & Acceptance Criteria

### Story 1: Access Exam Management Page

**As a** teacher  
**I want to** access a dedicated exams page  
**So that** I can view, create, and manage all my exams in one place

**Acceptance Criteria:**

- [ ] Navigation menu includes "Exams" link accessible to authenticated teachers
- [ ] Exams page displays a table/grid of all user's exams (draft and published)
- [ ] Each exam shows: Name, Subject, Grade, Topic, Status (Draft/Active), Created Date
- [ ] Empty state message displays when no exams exist: "No exams yet. Create your first exam to get started."
- [ ] Loading state displays skeleton loaders while fetching data
- [ ] Error state displays user-friendly message if API fails

**Technical Validation:**

- [ ] `useQuery` fetches exams with proper error/loading states
- [ ] Query key: `['exams', 'list']` for cache management
- [ ] Exams are filtered by authenticated user ID (server-side)
- [ ] Table is responsive (cards on mobile, table on desktop)

---

### Story 2: Create New Exam (Basic Information)

**As a** teacher  
**I want to** create a new exam with basic information  
**So that** I can define what content the exam will cover

**Acceptance Criteria:**

- [ ] "Create Exam" button (+ icon) is prominently displayed on exams page
- [ ] Clicking opens a dialog/sheet with "Create Exam" form
- [ ] Form includes fields:
  - **Name** (required, 3-200 characters) - Text input
  - **Description** (required, 10-1000 characters) - Textarea
  - **Grade** (required) - Select dropdown (1-12)
  - **Subject** (required) - Select dropdown, dynamically loaded based on grade
  - **Topic** (required) - Select dropdown, dynamically loaded based on selected subject
- [ ] Subject dropdown:
  - Loads subjects for selected grade via API
  - Shows loading state while fetching
  - Displays "Select a grade first" if no grade selected
- [ ] Topic dropdown:
  - Loads topics for selected subject via API
  - Shows loading state while fetching
  - Displays "Select a subject first" if no subject selected
- [ ] Form validation:
  - Required fields show error on blur if empty
  - Character limits enforced with live character counter
  - Submit button disabled until all fields valid
- [ ] On successful submission:
  - Dialog closes
  - Success toast: "Exam created successfully"
  - User is redirected to exam detail page OR matrix builder (if implemented)
  - Exam list query is invalidated and refetched
- [ ] On error:
  - Error toast displays server error message
  - Form remains open for correction
  - Submit button re-enables

**Technical Validation:**

- [ ] Zod schema defined for `CreateExamRequest`
- [ ] React Hook Form with `zodResolver` handles validation
- [ ] `useMutation` for exam creation with optimistic updates
- [ ] Cascade loading: Grade â†’ Subject â†’ Topic
- [ ] `FormProvider` used if form becomes multi-step later

---

### Story 3: Define Exam Matrix (Optional)

**As a** teacher  
**I want to** define a test specification matrix for my exam  
**So that** I can ensure balanced coverage of cognitive levels and topics

**Matrix Structure:**

The exam matrix follows Bloom's Taxonomy and specifies question distribution:

| Topic/Subtopic | Remember | Understand | Apply | Analyze | Evaluate | Create | Total  | Weight (%) |
| -------------- | -------- | ---------- | ----- | ------- | -------- | ------ | ------ | ---------- |
| Topic 1        | 2        | 3          | 2     | 1       | 1        | 1      | 10     | 33%        |
| Topic 2        | 1        | 2          | 3     | 2       | 1        | 1      | 10     | 33%        |
| Topic 3        | 1        | 2          | 2     | 2       | 1        | 2      | 10     | 34%        |
| **Total**      | **4**    | **7**      | **7** | **5**   | **3**    | **4**  | **30** | **100%**   |

**Acceptance Criteria:**

- [ ] After creating exam, user is presented with option: "Add Matrix" or "Skip to Questions"
- [ ] Matrix builder displays in a dialog/sheet or dedicated page
- [ ] UI shows:
  - **Matrix Table** with rows for topics/subtopics
  - **Columns** for cognitive levels: Remember, Understand, Apply, Analyze, Evaluate, Create
  - **Input fields** (number type) for specifying question count per cell
  - **Calculated totals** for each row and column
  - **Weight percentage** auto-calculated for each topic
- [ ] Topic rows are pre-populated from exam's selected topics (at minimum, the main topic)
- [ ] User can add subtopics by clicking "+ Add Subtopic" button
- [ ] Validation:
  - All cells default to 0
  - Only non-negative integers allowed
  - Total question count must be > 0 to save
  - Warning if matrix is unbalanced (e.g., all questions in one cognitive level)
- [ ] Save button:
  - Sends matrix data to `POST /api/exams/matrices`
  - Displays success toast: "Matrix saved successfully"
  - Advances to question creation/selection step
- [ ] Skip button:
  - Saves exam without matrix
  - Advances directly to question bank

**Technical Validation:**

- [ ] Matrix data stored as JSON in database (MatrixData table or JSON column)
- [ ] React Hook Form with dynamic fields (`useFieldArray` for rows)
- [ ] Auto-calculation logic updates totals on every input change
- [ ] Matrix validation prevents saving if total = 0
- [ ] `useMutation` for matrix creation with error handling

---

### Story 4: Manage Question Bank

**As a** teacher  
**I want to** create, edit, and organize questions in a question bank  
**So that** I can build a reusable library of assessment items

**Acceptance Criteria:**

**4a. View Question Bank**

- [ ] "Questions" tab or page accessible from main navigation
- [ ] Table displays all questions created by user with columns:
  - **Content** (truncated preview, 50 chars max)
  - **Type** (Multiple Choice, True/False, Essay, etc.)
  - **Cognitive Level** (Remember, Understand, Apply, etc.)
  - **Topic** (subject area)
  - **Public/Private** (badge indicator)
  - **Actions** (Edit, Delete, View)
- [ ] Filters available:
  - By Topic (dropdown)
  - By Cognitive Level (dropdown)
  - By Public/Private (toggle)
- [ ] Search bar filters by question content
- [ ] Pagination controls for large question sets (20 questions per page)

**4b. Create Question**

- [ ] "Create Question" button opens form dialog/sheet
- [ ] Form fields:
  - **Content** (required, rich text editor or textarea, max 2000 chars)
  - **Type** (required, dropdown: Multiple Choice, True/False, Short Answer, Essay)
  - **Cognitive Level** (required, dropdown: Remember, Understand, Apply, Analyze, Evaluate, Create)
  - **Point Value** (required, number, min 1, max 100)
  - **Topic** (required, select from topics)
  - **Source** (optional, text, e.g., "Textbook Chapter 3")
  - **Media URL** (optional, S3 URL for images/diagrams)
  - **Is Public** (checkbox, defaults to false)
  - **Answers** (dynamic array based on question type)
    - Multiple Choice: Add/remove answer options, mark correct answer(s)
    - True/False: Radio buttons for correct answer
    - Essay/Short Answer: Model answer (optional)
- [ ] Validation:
  - Content required, min 10 characters
  - Multiple Choice must have at least 2 options and 1 correct answer
  - Point value must be positive integer
- [ ] On success:
  - Success toast: "Question created successfully"
  - Question appears in question bank table
  - Form resets for creating another question or closes

**4c. Edit Question**

- [ ] Clicking "Edit" on question row opens pre-populated form
- [ ] All fields editable
- [ ] Save button sends `PUT /api/exams/questions/{id}`
- [ ] Success toast: "Question updated successfully"
- [ ] Table row updates immediately (optimistic update)

**4d. Delete Question**

- [ ] Clicking "Delete" shows confirmation dialog:
  - "Are you sure you want to delete this question? This action cannot be undone."
  - "Cancel" and "Delete" buttons
- [ ] On confirm:
  - Sends `DELETE /api/exams/questions/{id}`
  - Success toast: "Question deleted successfully"
  - Question removed from table (optimistic update)
  - If question is used in exams, show warning: "This question is used in 3 exams. Are you sure?"

**Technical Validation:**

- [ ] TanStack Query with query keys: `['questions', { topicId, cognitiveLevel, isPublic }]`
- [ ] Optimistic updates for create/edit/delete mutations
- [ ] Rich text editor (optional, can use textarea initially)
- [ ] Dynamic form fields for answers based on question type
- [ ] Proper error handling with rollback on mutation failure
- [ ] Filter/search implemented client-side or server-side based on data volume

---

### Story 5: Associate Questions with Exam

**As a** teacher  
**I want to** add questions from my question bank to an exam  
**So that** I can assemble the exam content

**Acceptance Criteria:**

- [ ] Exam detail page includes "Questions" section showing current exam questions
- [ ] "Add Questions" button opens question selector dialog
- [ ] Dialog displays:
  - **Available Questions table** (questions not yet added to this exam)
  - **Filters** (Topic, Cognitive Level, Public/Private)
  - **Search bar** (filter by content)
  - **Selection checkboxes** for each question
  - **"Select All" / "Deselect All"** buttons
  - **Selected count** display: "5 questions selected"
- [ ] "Add Selected Questions" button:
  - Sends `POST /api/exams/exams/{examId}/questions` with `{ questionIds: [...] }`
  - Success toast: "5 questions added to exam"
  - Closes dialog
  - Exam questions list updates immediately
- [ ] Exam questions section shows:
  - **Reorderable list** (drag-and-drop to reorder)
  - **Question preview** (content, type, points)
  - **Remove button** for each question
- [ ] Remove question:
  - Sends `DELETE /api/exams/exams/{examId}/questions/{questionId}`
  - Success toast: "Question removed from exam"
  - Question disappears from list (optimistic update)

**Matrix-Guided Selection (if matrix defined):**

- [ ] If exam has a matrix, dialog shows matrix requirements:
  - "Your matrix requires: 2 'Remember' questions from Topic 1"
  - Questions that fulfill matrix requirements are highlighted/badged
- [ ] After adding questions, show matrix fulfillment status:
  - Green checkmarks for fulfilled cells
  - Red warnings for unfulfilled cells
  - Summary: "Matrix 80% complete (24/30 questions)"

**Technical Validation:**

- [ ] `useMutation` for adding/removing questions with optimistic updates
- [ ] Drag-and-drop library (e.g., `dnd-kit` or native HTML5 drag API)
- [ ] Query invalidation: `['exams', examId, 'questions']` after mutations
- [ ] Prevent adding duplicate questions (validation on frontend and backend)

---

### Story 6: Publish Exam

**As a** teacher  
**I want to** publish a draft exam  
**So that** it becomes active and accessible for students

**Acceptance Criteria:**

- [ ] Exam detail page shows status badge: "Draft" (gray) or "Active" (green)
- [ ] "Publish Exam" button visible only for draft exams
- [ ] Validation before publishing:
  - Exam must have at least 1 question
  - Warning if exam has no matrix: "This exam has no test specification matrix. Publish anyway?"
- [ ] Clicking "Publish Exam" shows confirmation dialog:
  - "Are you sure you want to publish this exam? Students will be able to access it."
  - "Cancel" and "Publish" buttons
- [ ] On confirm:
  - Sends `POST /api/exams/exams/{examId}/publish`
  - Success toast: "Exam published successfully"
  - Status badge updates to "Active"
  - "Publish" button disappears
  - "Unpublish" button appears (optional, for reverting to draft)
- [ ] Published exams cannot be deleted (only archived/unpublished)

**Technical Validation:**

- [ ] `useMutation` for publish action
- [ ] Query invalidation: `['exams', examId]` and `['exams', 'list']`
- [ ] Backend validates exam has questions before allowing publish
- [ ] Domain event: `ExamPublishedDomainEvent` raised on backend

---

## Architecture & Design

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Pages: /exams, /exams/:id, /questions                  â”‚   â”‚
â”‚  â”‚  Components: ExamList, ExamForm, MatrixBuilder,         â”‚   â”‚
â”‚  â”‚              QuestionBank, QuestionForm                  â”‚   â”‚
â”‚  â”‚  State: TanStack Query + Zustand (UI state)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS (REST API)
                            â”‚ JWT Bearer Token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Exam Microservice (C#)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API Layer (Controllers, Minimal APIs)                   â”‚   â”‚
â”‚  â”‚   GET    /api/exams/exams                               â”‚   â”‚
â”‚  â”‚   POST   /api/exams/exams                               â”‚   â”‚
â”‚  â”‚   GET    /api/exams/exams/{id}                          â”‚   â”‚
â”‚  â”‚   PUT    /api/exams/exams/{id}                          â”‚   â”‚
â”‚  â”‚   DELETE /api/exams/exams/{id}                          â”‚   â”‚
â”‚  â”‚   POST   /api/exams/exams/{id}/publish                  â”‚   â”‚
â”‚  â”‚   POST   /api/exams/matrices                            â”‚   â”‚
â”‚  â”‚   GET    /api/exams/questions                           â”‚   â”‚
â”‚  â”‚   POST   /api/exams/questions                           â”‚   â”‚
â”‚  â”‚   PUT    /api/exams/questions/{id}                      â”‚   â”‚
â”‚  â”‚   DELETE /api/exams/questions/{id}                      â”‚   â”‚
â”‚  â”‚   GET    /api/exams/exams/{examId}/questions            â”‚   â”‚
â”‚  â”‚   POST   /api/exams/exams/{examId}/questions            â”‚   â”‚
â”‚  â”‚   DELETE /api/exams/exams/{examId}/questions/{qId}      â”‚   â”‚
â”‚  â”‚   GET    /api/exams/subjects?grade={grade}              â”‚   â”‚
â”‚  â”‚   GET    /api/exams/subjects/{id}/topics                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Application Layer (CQRS Handlers)                       â”‚   â”‚
â”‚  â”‚   Commands: CreateExam, UpdateExam, PublishExam,        â”‚   â”‚
â”‚  â”‚             CreateMatrix, CreateQuestion, etc.          â”‚   â”‚
â”‚  â”‚   Queries: GetExams, GetExamById, GetQuestions, etc.    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Domain Layer                                             â”‚   â”‚
â”‚  â”‚   Entities: Exam, Question, ExamQuestion, Matrix        â”‚   â”‚
â”‚  â”‚   Value Objects: CognitiveLevel, QuestionType           â”‚   â”‚
â”‚  â”‚   Events: ExamCreated, ExamPublished, QuestionAdded     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Infrastructure Layer                                     â”‚   â”‚
â”‚  â”‚   EF Core DbContext, Repositories, SQL Server           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Schema (Simplified)

**Current Schema (Already Implemented):**

```sql
-- Exams Table
CREATE TABLE Exams (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL,
    Description NVARCHAR(1000) NOT NULL,
    TopicId UNIQUEIDENTIFIER NOT NULL,
    SubjectId UNIQUEIDENTIFIER NOT NULL,
    Grade INT NOT NULL,
    IsDraft BIT NOT NULL DEFAULT 1,
    IsActive BIT NOT NULL DEFAULT 0,
    CreatedBy NVARCHAR(450) NOT NULL, -- Cognito User ID
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2 NULL,
    IsDeleted BIT NOT NULL DEFAULT 0,
    INDEX IX_Exams_CreatedBy (CreatedBy),
    INDEX IX_Exams_TopicId (TopicId),
    INDEX IX_Exams_SubjectId (SubjectId)
);

-- Questions Table
CREATE TABLE Questions (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    Content NVARCHAR(2000) NOT NULL,
    Type INT NOT NULL, -- Enum: MultipleChoice, TrueFalse, ShortAnswer, Essay
    CognitiveLevel INT NOT NULL, -- Enum: Remember, Understand, Apply, Analyze, Evaluate, Create
    Point DECIMAL(5,2) NOT NULL,
    TopicId UNIQUEIDENTIFIER NOT NULL,
    Source NVARCHAR(500) NULL,
    MediaUrl NVARCHAR(1000) NULL,
    IsPublic BIT NOT NULL DEFAULT 0,
    CreatedBy NVARCHAR(450) NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2 NULL,
    IsDeleted BIT NOT NULL DEFAULT 0,
    INDEX IX_Questions_CreatedBy (CreatedBy),
    INDEX IX_Questions_TopicId (TopicId),
    INDEX IX_Questions_CognitiveLevel (CognitiveLevel)
);

-- Answers Table
CREATE TABLE Answers (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    QuestionId UNIQUEIDENTIFIER NOT NULL,
    Content NVARCHAR(1000) NOT NULL,
    IsCorrect BIT NOT NULL,
    DisplayOrder INT NOT NULL,
    FOREIGN KEY (QuestionId) REFERENCES Questions(Id) ON DELETE CASCADE,
    INDEX IX_Answers_QuestionId (QuestionId)
);

-- ExamQuestions (Join Table)
CREATE TABLE ExamQuestions (
    ExamId UNIQUEIDENTIFIER NOT NULL,
    QuestionId UNIQUEIDENTIFIER NOT NULL,
    DisplayOrder INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    PRIMARY KEY (ExamId, QuestionId),
    FOREIGN KEY (ExamId) REFERENCES Exams(Id) ON DELETE CASCADE,
    FOREIGN KEY (QuestionId) REFERENCES Questions(Id) ON DELETE CASCADE
);

-- Matrices Table (Optional, stores test specification matrices)
CREATE TABLE Matrices (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    ExamId UNIQUEIDENTIFIER NOT NULL,
    MatrixData NVARCHAR(MAX) NOT NULL, -- JSON serialized matrix
    TotalQuestions INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL,
    FOREIGN KEY (ExamId) REFERENCES Exams(Id) ON DELETE CASCADE,
    INDEX IX_Matrices_ExamId (ExamId)
);

-- Subjects Table (Reference Data)
CREATE TABLE Subjects (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Grade INT NOT NULL,
    INDEX IX_Subjects_Grade (Grade)
);

-- Topics Table (Reference Data)
CREATE TABLE Topics (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    SubjectId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (SubjectId) REFERENCES Subjects(Id),
    INDEX IX_Topics_SubjectId (SubjectId)
);
```

**Notes:**

- âœ… Schema already migrated and deployed
- âœ… Exam entity simplified (no duration, scheduling, access codes)
- âœ… Question bank architecture supports reusability
- âœ… Soft delete implemented with `IsDeleted` flag

---

## Frontend Implementation

### 1. Install Required Shadcn Components

**Installation Command:**

```bash
npx shadcn@latest add @shadcn/dialog @shadcn/form @shadcn/table @shadcn/card @shadcn/button @shadcn/input @shadcn/select @shadcn/badge @shadcn/separator @shadcn/tabs @shadcn/sheet @shadcn/sonner
```

**Checklist:**

- [ ] Run installation command in frontend directory
- [ ] Verify components appear in `src/components/ui/`
- [ ] Test import: `import { Button } from "@/components/ui/button"`

---

### 3. Key Components Implementation

#### 3.1 ExamList Component

**File:** `src/features/exams/components/ExamList.tsx`

**Responsibilities:**

- Fetch and display list of user's exams
- Handle loading, error, and empty states
- Provide navigation to exam detail page
- Trigger create exam dialog

**Implementation Pattern:**

```tsx
import { useExams } from "../hooks/useExams";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableCell,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { PlusIcon } from "lucide-react";
import { CreateExamDialog } from "./CreateExamDialog";

export function ExamList() {
  const { data: exams, isLoading, isError, error } = useExams();
  const [createDialogOpen, setCreateDialogOpen] = useState(false);

  if (isLoading) return <TableSkeleton />;
  if (isError) return <ErrorAlert message={error.message} />;
  if (!exams || exams.length === 0) {
    return (
      <EmptyState
        title="No exams yet"
        description="Create your first exam to get started."
        action={
          <Button onClick={() => setCreateDialogOpen(true)}>
            <PlusIcon /> Create Exam
          </Button>
        }
      />
    );
  }

  return (
    <>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">My Exams</h1>
        <Button onClick={() => setCreateDialogOpen(true)}>
          <PlusIcon /> Create Exam
        </Button>
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableCell>Name</TableCell>
            <TableCell>Subject</TableCell>
            <TableCell>Grade</TableCell>
            <TableCell>Status</TableCell>
            <TableCell>Created</TableCell>
            <TableCell>Actions</TableCell>
          </TableRow>
        </TableHeader>
        <TableBody>
          {exams.map((exam) => (
            <TableRow key={exam.id}>
              <TableCell>{exam.name}</TableCell>
              <TableCell>{exam.subject?.name}</TableCell>
              <TableCell>{exam.grade}</TableCell>
              <TableCell>
                <Badge variant={exam.isDraft ? "secondary" : "success"}>
                  {exam.isDraft ? "Draft" : "Active"}
                </Badge>
              </TableCell>
              <TableCell>{formatDate(exam.createdAt)}</TableCell>
              <TableCell>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => navigate(`/exams/${exam.id}`)}
                >
                  View
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      <CreateExamDialog
        open={createDialogOpen}
        onOpenChange={setCreateDialogOpen}
      />
    </>
  );
}
```

**Checklist:**

- [ ] Component renders exam table with all required columns
- [ ] Loading skeleton displays while fetching
- [ ] Error alert shows user-friendly message
- [ ] Empty state with "Create Exam" CTA displays when no exams
- [ ] Status badge shows correct color (gray for draft, green for active)
- [ ] Create Exam button opens dialog
- [ ] Row click/View button navigates to exam detail page

---

#### 3.2 CreateExamDialog Component

**File:** `src/features/exams/components/CreateExamDialog.tsx`

**Responsibilities:**

- Render form dialog for creating new exam
- Handle cascade loading: Grade â†’ Subject â†’ Topic
- Validate form with Zod
- Submit data via mutation
- Show success/error feedback

**Implementation Pattern (using React Hook Form + Zod):**

```tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { useCreateExam } from "../hooks/useExams";
import { useSubjects } from "../hooks/useSubjects";
import { useTopics } from "../hooks/useTopics";
import { examSchema } from "../schemas/examSchema";

type ExamFormData = z.infer<typeof examSchema>;

interface CreateExamDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function CreateExamDialog({
  open,
  onOpenChange,
}: CreateExamDialogProps) {
  const form = useForm<ExamFormData>({
    resolver: zodResolver(examSchema),
    defaultValues: {
      name: "",
      description: "",
      grade: undefined,
      subjectId: "",
      topicId: "",
    },
  });

  const createExamMutation = useCreateExam();

  // Watch grade and subjectId for cascade loading
  const selectedGrade = form.watch("grade");
  const selectedSubjectId = form.watch("subjectId");

  // Fetch subjects based on selected grade
  const { data: subjects, isLoading: loadingSubjects } = useSubjects(
    selectedGrade,
    {
      enabled: !!selectedGrade,
    },
  );

  // Fetch topics based on selected subject
  const { data: topics, isLoading: loadingTopics } = useTopics(
    selectedSubjectId,
    {
      enabled: !!selectedSubjectId,
    },
  );

  const onSubmit = async (data: ExamFormData) => {
    try {
      await createExamMutation.mutateAsync(data);
      toast.success("Exam created successfully");
      form.reset();
      onOpenChange(false);
    } catch (error) {
      toast.error(error.message || "Failed to create exam");
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>Create New Exam</DialogTitle>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Exam Name</FormLabel>
                  <FormControl>
                    <Input
                      placeholder="e.g., Midterm Exam - Chapter 1-3"
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Description</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="Brief description of exam content and objectives"
                      rows={4}
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="grade"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Grade</FormLabel>
                  <Select
                    onValueChange={(value) => field.onChange(Number(value))}
                    value={String(field.value)}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select grade" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map((grade) => (
                        <SelectItem key={grade} value={String(grade)}>
                          Grade {grade}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="subjectId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Subject</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    value={field.value}
                    disabled={!selectedGrade}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue
                          placeholder={
                            selectedGrade
                              ? "Select subject"
                              : "Select a grade first"
                          }
                        />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {loadingSubjects ? (
                        <SelectItem value="_loading" disabled>
                          Loading...
                        </SelectItem>
                      ) : (
                        subjects?.map((subject) => (
                          <SelectItem key={subject.id} value={subject.id}>
                            {subject.name}
                          </SelectItem>
                        ))
                      )}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="topicId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Topic</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    value={field.value}
                    disabled={!selectedSubjectId}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue
                          placeholder={
                            selectedSubjectId
                              ? "Select topic"
                              : "Select a subject first"
                          }
                        />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {loadingTopics ? (
                        <SelectItem value="_loading" disabled>
                          Loading...
                        </SelectItem>
                      ) : (
                        topics?.map((topic) => (
                          <SelectItem key={topic.id} value={topic.id}>
                            {topic.name}
                          </SelectItem>
                        ))
                      )}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-3 pt-4">
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
              >
                Cancel
              </Button>
              <Button type="submit" disabled={createExamMutation.isPending}>
                {createExamMutation.isPending ? "Creating..." : "Create Exam"}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

**Checklist:**

- [ ] Form renders with all required fields
- [ ] Zod validation schema enforces character limits and required fields
- [ ] Grade dropdown populated with values 1-12
- [ ] Subject dropdown disabled until grade selected
- [ ] Subject dropdown loads subjects for selected grade dynamically
- [ ] Topic dropdown disabled until subject selected
- [ ] Topic dropdown loads topics for selected subject dynamically
- [ ] Submit button disabled while mutation is pending
- [ ] Success toast displays on successful creation
- [ ] Error toast displays on failure
- [ ] Form resets and dialog closes on success

---

#### 3.3 QuestionBank Component

**File:** `src/features/exams/components/QuestionBank.tsx`

**Responsibilities:**

- Display table of all user's questions
- Provide filters (topic, cognitive level, public/private)
- Implement search functionality
- Handle create, edit, delete actions

**Checklist:**

- [ ] Table displays questions with columns: Content (preview), Type, Cognitive Level, Topic, Public/Private, Actions
- [ ] Filters: Topic (dropdown), Cognitive Level (dropdown), Is Public (toggle)
- [ ] Search bar filters by question content
- [ ] "Create Question" button opens QuestionForm dialog
- [ ] Edit button opens pre-populated QuestionForm
- [ ] Delete button shows confirmation dialog before deletion
- [ ] Pagination controls (if > 20 questions)
- [ ] Loading skeleton during data fetch
- [ ] Empty state when no questions match filters

---

#### 3.4 QuestionForm Component

**File:** `src/features/exams/components/QuestionForm.tsx`

**Responsibilities:**

- Render form for creating/editing questions
- Handle dynamic answer fields based on question type
- Validate with Zod
- Submit via mutation

**Dynamic Fields Logic:**

- **Multiple Choice:** Show "Add Answer" button, allow marking correct answer(s)
- **True/False:** Show radio buttons for True/False
- **Short Answer/Essay:** Optional model answer field

**Checklist:**

- [ ] Form fields: Content, Type, Cognitive Level, Point, Topic, Source, Media URL, Is Public
- [ ] Answer fields dynamically render based on selected question type
- [ ] Multiple Choice: Add/remove answer options, mark correct
- [ ] Validation: Content min 10 chars, Multiple Choice requires 2+ options and 1 correct
- [ ] Submit creates or updates question based on mode (create vs edit)
- [ ] Success/error feedback via toast

---

#### 3.5 MatrixBuilder Component (Optional)

**File:** `src/features/exams/components/MatrixBuilder.tsx`

**Responsibilities:**

- Render test specification matrix table
- Pre-populate rows with exam topics
- Allow adding subtopics
- Calculate totals and weights automatically
- Validate matrix before saving

**Implementation Notes:**

- Use `useFieldArray` from React Hook Form for dynamic rows
- Implement controlled inputs for each cell
- Auto-calculation: `useEffect` watches all cell values and updates totals
- Validation: Total questions > 0, only non-negative integers

**Checklist:**

- [ ] Matrix table renders with columns: Topic, Remember, Understand, Apply, Analyze, Evaluate, Create, Total, Weight %
- [ ] Rows pre-populated with exam's topics
- [ ] "+ Add Subtopic" button adds new row
- [ ] Number inputs for each cognitive level cell
- [ ] Totals auto-calculate for rows and columns
- [ ] Weight % auto-calculates for each topic
- [ ] Save button disabled if total = 0
- [ ] Warning message if matrix is unbalanced
- [ ] Success toast on save

---

### 4. TanStack Query Hooks

#### 4.1 useExams Hook

**File:** `src/features/exams/hooks/useExams.ts`

```tsx
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { assessmentService } from "@/services/exam-microservice/exam.service";
import type { Exam, CreateExamRequest } from "@/types";

export function useExams(isDraft?: boolean) {
  return useQuery({
    queryKey: ["exams", "list", { isDraft }],
    queryFn: () => assessmentService.getExams(isDraft),
    staleTime: 1000 * 60 * 5, // 5 minutes
  });
}

export function useExamById(examId: string) {
  return useQuery({
    queryKey: ["exams", examId],
    queryFn: () => assessmentService.getExamById(examId),
    enabled: !!examId,
  });
}

export function useCreateExam() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateExamRequest) => assessmentService.createExam(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["exams", "list"] });
    },
  });
}

export function useUpdateExam(examId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: Partial<CreateExamRequest>) =>
      assessmentService.updateExam(examId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["exams", examId] });
      queryClient.invalidateQueries({ queryKey: ["exams", "list"] });
    },
  });
}

export function usePublishExam(examId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: () => assessmentService.publishExam(examId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["exams", examId] });
      queryClient.invalidateQueries({ queryKey: ["exams", "list"] });
    },
  });
}

export function useDeleteExam() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (examId: string) => assessmentService.deleteExam(examId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["exams", "list"] });
    },
  });
}
```

**Checklist:**

- [ ] Query keys are hierarchical and descriptive
- [ ] Mutations invalidate relevant queries on success
- [ ] Stale time set appropriately (5 minutes for list data)
- [ ] `enabled` flag used for dependent queries

---

#### 4.2 useQuestions Hook

**File:** `src/features/exams/hooks/useQuestions.ts`

```tsx
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { assessmentService } from "@/services/exam-microservice/exam.service";
import type { Question, CreateQuestionRequest, CognitiveLevel } from "@/types";

export function useQuestions(filters?: {
  topicId?: string;
  cognitiveLevel?: CognitiveLevel;
  isPublic?: boolean;
}) {
  return useQuery({
    queryKey: ["questions", filters],
    queryFn: () => assessmentService.getQuestions(filters),
    staleTime: 1000 * 60 * 3, // 3 minutes
  });
}

export function useCreateQuestion() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateQuestionRequest) =>
      assessmentService.createQuestion(data),
    onMutate: async (newQuestion) => {
      // Cancel outgoing queries
      await queryClient.cancelQueries({ queryKey: ["questions"] });

      // Snapshot previous value
      const previousQuestions = queryClient.getQueryData(["questions"]);

      // Optimistically update cache
      queryClient.setQueryData(["questions"], (old: any) => ({
        questions: [
          ...(old?.questions || []),
          { ...newQuestion, id: "temp-" + Date.now() },
        ],
      }));

      return { previousQuestions };
    },
    onError: (err, newQuestion, context) => {
      // Rollback on error
      queryClient.setQueryData(["questions"], context?.previousQuestions);
    },
    onSettled: () => {
      // Refetch to ensure server state
      queryClient.invalidateQueries({ queryKey: ["questions"] });
    },
  });
}

export function useUpdateQuestion(questionId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: Partial<CreateQuestionRequest>) =>
      assessmentService.updateQuestion(questionId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["questions"] });
    },
  });
}

export function useDeleteQuestion() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (questionId: string) =>
      assessmentService.deleteQuestion(questionId),
    onMutate: async (questionId) => {
      await queryClient.cancelQueries({ queryKey: ["questions"] });
      const previousQuestions = queryClient.getQueryData(["questions"]);

      queryClient.setQueryData(["questions"], (old: any) => ({
        questions:
          old?.questions.filter((q: Question) => q.id !== questionId) || [],
      }));

      return { previousQuestions };
    },
    onError: (err, questionId, context) => {
      queryClient.setQueryData(["questions"], context?.previousQuestions);
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ["questions"] });
    },
  });
}
```

**Checklist:**

- [ ] Optimistic updates implemented for create and delete
- [ ] Rollback logic on error
- [ ] Query invalidation after successful mutations
- [ ] Filters included in query key for proper caching

---

#### 4.3 useSubjects and useTopics Hooks

**File:** `src/features/exams/hooks/useSubjects.ts`

```tsx
import { useQuery } from "@tanstack/react-query";
import { assessmentService } from "@/services/exam-microservice/exam.service";

export function useSubjects(grade?: number, options?: { enabled?: boolean }) {
  return useQuery({
    queryKey: ["subjects", { grade }],
    queryFn: () => assessmentService.getSubjects(grade),
    staleTime: 1000 * 60 * 10, // 10 minutes (reference data changes infrequently)
    enabled: options?.enabled !== false && grade !== undefined,
  });
}
```

**File:** `src/features/exams/hooks/useTopics.ts`

```tsx
import { useQuery } from "@tanstack/react-query";
import { assessmentService } from "@/services/exam-microservice/exam.service";

export function useTopics(subjectId?: string, options?: { enabled?: boolean }) {
  return useQuery({
    queryKey: ["topics", { subjectId }],
    queryFn: () => assessmentService.getTopics(subjectId!),
    staleTime: 1000 * 60 * 10, // 10 minutes
    enabled: options?.enabled !== false && !!subjectId,
  });
}
```

**Checklist:**

- [ ] Queries only run when dependencies are available (`enabled` flag)
- [ ] Long stale time (10 min) since reference data rarely changes
- [ ] Query keys include filter parameters

---

### 5. Zod Validation Schemas

#### 5.1 Exam Schema

**File:** `src/features/exams/schemas/examSchema.ts`

```tsx
import { z } from "zod";

export const examSchema = z.object({
  name: z
    .string()
    .min(3, "Exam name must be at least 3 characters")
    .max(200, "Exam name cannot exceed 200 characters"),
  description: z
    .string()
    .min(10, "Description must be at least 10 characters")
    .max(1000, "Description cannot exceed 1000 characters"),
  grade: z
    .number({ required_error: "Grade is required" })
    .int()
    .min(1, "Grade must be between 1 and 12")
    .max(12, "Grade must be between 1 and 12"),
  subjectId: z.string().uuid("Invalid subject ID"),
  topicId: z.string().uuid("Invalid topic ID"),
});

export type ExamFormData = z.infer<typeof examSchema>;
```

---

#### 5.2 Question Schema

**File:** `src/features/exams/schemas/questionSchema.ts`

```tsx
import { z } from "zod";
import { QuestionType, CognitiveLevel } from "@/types/model/exams";

const answerSchema = z.object({
  content: z.string().min(1, "Answer content is required"),
  isCorrect: z.boolean(),
  displayOrder: z.number().int().min(0),
});

export const questionSchema = z
  .object({
    content: z
      .string()
      .min(10, "Question content must be at least 10 characters")
      .max(2000, "Question content cannot exceed 2000 characters"),
    type: z.nativeEnum(QuestionType),
    cognitiveLevel: z.nativeEnum(CognitiveLevel),
    point: z
      .number({ required_error: "Point value is required" })
      .positive("Point value must be positive")
      .max(100, "Point value cannot exceed 100"),
    topicId: z.string().uuid("Invalid topic ID"),
    source: z.string().max(500).optional(),
    mediaUrl: z.string().url("Invalid URL").optional().or(z.literal("")),
    isPublic: z.boolean().default(false),
    answers: z
      .array(answerSchema)
      .min(2, "At least 2 answers required for multiple choice")
      .refine(
        (answers) => answers.some((a) => a.isCorrect),
        "At least one answer must be marked as correct",
      )
      .optional(),
  })
  .refine(
    (data) => {
      if (data.type === QuestionType.MultipleChoice) {
        return data.answers && data.answers.length >= 2;
      }
      return true;
    },
    {
      message: "Multiple choice questions must have at least 2 answers",
      path: ["answers"],
    },
  );

export type QuestionFormData = z.infer<typeof questionSchema>;
```

---

## Backend Verification

**Backend endpoints are already implemented.** Verify the following:

### API Endpoints Checklist

- [ ] `GET /api/exams/exams?isDraft={bool}` - Returns list of exams for authenticated user
- [ ] `POST /api/exams/exams` - Creates new exam (accepts CreateExamRequest DTO)
- [ ] `GET /api/exams/exams/{id}` - Returns single exam details
- [ ] `PUT /api/exams/exams/{id}` - Updates exam
- [ ] `DELETE /api/exams/exams/{id}` - Soft deletes exam (only if draft)
- [ ] `POST /api/exams/exams/{id}/publish` - Publishes draft exam
- [ ] `POST /api/exams/matrices` - Creates test specification matrix
- [ ] `GET /api/exams/questions?topicId={guid}&cognitiveLevel={enum}&isPublic={bool}` - Returns filtered questions
- [ ] `POST /api/exams/questions` - Creates new question
- [ ] `PUT /api/exams/questions/{id}` - Updates question
- [ ] `DELETE /api/exams/questions/{id}` - Soft deletes question
- [ ] `GET /api/exams/exams/{examId}/questions` - Returns questions in exam
- [ ] `POST /api/exams/exams/{examId}/questions` - Adds questions to exam (accepts { questionIds: [...] })
- [ ] `DELETE /api/exams/exams/{examId}/questions/{questionId}` - Removes question from exam
- [ ] `GET /api/exams/subjects?grade={int}` - Returns subjects for grade
- [ ] `GET /api/exams/subjects/{id}/topics` - Returns topics for subject

### Authorization Verification

- [ ] All endpoints extract userId from JWT token (via `GetAuthenticatedUserId()`)
- [ ] Queries filter data by userId (user can only see their own exams/questions)
- [ ] Public questions are accessible to all users
- [ ] Cannot modify/delete other users' data (enforced in repository layer)

### Validation Verification

- [ ] CreateExamCommand validates all required fields with FluentValidation
- [ ] CreateQuestionCommand validates answers based on question type
- [ ] PublishExamCommand validates exam has at least 1 question
- [ ] Cannot delete published exams (only draft exams)

---

## Data Flow & State Management

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  User Interaction (UI)                        â”‚
â”‚  Click "Create Exam" â†’ Open Dialog â†’ Fill Form â†’ Submit      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              React Hook Form + Zod Validation                 â”‚
â”‚  â€¢ Validates fields on blur and submit                       â”‚
â”‚  â€¢ Displays inline error messages                            â”‚
â”‚  â€¢ Prevents submission if invalid                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ (if valid)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                TanStack Query useMutation                     â”‚
â”‚  1. onMutate: Cancel queries, snapshot cache, optimistic UI  â”‚
â”‚  2. mutationFn: POST /api/exams/exams                        â”‚
â”‚  3. onSuccess: Invalidate queries, show success toast        â”‚
â”‚  4. onError: Rollback cache, show error toast                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Backend API (Exam Service)                   â”‚
â”‚  1. Controller receives request, extracts userId from JWT    â”‚
â”‚  2. Maps request to CreateExamCommand                        â”‚
â”‚  3. MediatR sends command to CreateExamCommandHandler        â”‚
â”‚  4. Handler validates, creates domain entity                 â”‚
â”‚  5. Repository saves to SQL Server                           â”‚
â”‚  6. Domain event raised: ExamCreatedDomainEvent              â”‚
â”‚  7. Response mapped to CreateExamResponse DTO                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Database (SQL Server)                       â”‚
â”‚  INSERT INTO Exams (Id, Name, Description, TopicId, ...)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Management Strategy

**TanStack Query (Server State):**

- Manages all API data (exams, questions, subjects, topics)
- Handles caching, refetching, background updates
- Query keys: `['exams', 'list']`, `['questions', filters]`, etc.
- Mutations: `useCreateExam`, `useUpdateQuestion`, etc.

**Zustand (Client State - Optional):**

- For global UI state (sidebar open/closed, theme, etc.)
- NOT used for exam/question data (TanStack Query handles that)

**React Hook Form (Form State):**

- Manages form state locally
- Integrates with Zod for validation
- Resets on successful submission

---

## Validation & Error Handling

### Frontend Validation

**Form Validation (Zod + React Hook Form):**

- [x] Required fields: name, description, grade, subjectId, topicId
- [x] Character limits: name (3-200), description (10-1000)
- [x] Grade range: 1-12
- [x] UUID format for IDs
- [x] Question content: min 10 chars, max 2000
- [x] Multiple choice: min 2 answers, at least 1 correct
- [x] Point value: positive number, max 100

**Real-Time Feedback:**

- [ ] Inline error messages on blur
- [ ] Character counters for text fields
- [ ] Disabled submit button when form invalid
- [ ] Loading state on submit button during mutation

### Backend Validation

**FluentValidation in Command Handlers:**

- [x] CreateExamCommandValidator checks all required fields
- [x] CreateQuestionCommandValidator validates question type and answers
- [x] PublishExamCommandValidator ensures exam has questions

**Business Logic Validation:**

- [x] Cannot publish exam with 0 questions
- [x] Cannot delete published exam (only draft)
- [x] Cannot add same question to exam twice

### Error Handling

**API Errors:**

- [ ] 400 Bad Request â†’ Show validation errors in toast
- [ ] 401 Unauthorized â†’ Redirect to login
- [ ] 403 Forbidden â†’ Show "You don't have permission"
- [ ] 404 Not Found â†’ Show "Exam not found"
- [ ] 500 Server Error â†’ Show "Something went wrong, please try again"

**Network Errors:**

- [ ] Timeout â†’ Show "Request timed out, please check your connection"
- [ ] No internet â†’ Show "No internet connection"

**Optimistic Update Rollback:**

- [ ] If mutation fails, revert optimistic update
- [ ] Show error toast with rollback message

---

## Testing Strategy

### Frontend Unit Tests (Vitest + React Testing Library)

- [ ] **ExamList Component:**
  - Renders loading skeleton when fetching
  - Displays empty state when no exams
  - Renders table with correct data
  - Opens create dialog on button click
- [ ] **CreateExamDialog Component:**
  - Validates required fields
  - Cascade loads subjects when grade selected
  - Cascade loads topics when subject selected
  - Submits valid data
  - Displays error on submission failure
- [ ] **QuestionForm Component:**
  - Renders correct fields based on question type
  - Validates multiple choice has 2+ answers
  - Validates at least 1 correct answer
  - Dynamically adds/removes answer fields

### Frontend Integration Tests

- [ ] **Exam Creation Flow:**
  - User creates exam â†’ exam appears in list
  - Form validation prevents invalid submission
  - Success toast displays after creation
- [ ] **Question Management Flow:**
  - User creates question â†’ question appears in bank
  - User adds question to exam â†’ question appears in exam
  - User removes question from exam â†’ question removed

### Backend Integration Tests (xUnit + EF Core InMemory)

- [x] **CreateExamCommandHandlerTests:**
  - Creates exam with valid data
  - Validates required fields
  - Associates exam with correct user
- [x] **PublishExamCommandHandlerTests:**
  - Publishes draft exam
  - Fails if exam has no questions
  - Raises ExamPublishedDomainEvent
- [x] **ExamRepositoryTests:**
  - GetByCreatorAsync returns only user's exams
  - GetDraftExamsAsync filters by isDraft flag

### Manual Testing Checklist

- [ ] Create exam with all fields â†’ Success
- [ ] Create exam missing required field â†’ Validation error
- [ ] Select grade â†’ Subjects load
- [ ] Select subject â†’ Topics load
- [ ] Create matrix â†’ Matrix saves and totals calculate correctly
- [ ] Create question â†’ Question appears in bank
- [ ] Add question to exam â†’ Question associated
- [ ] Remove question from exam â†’ Question disassociated
- [ ] Publish exam with 0 questions â†’ Error message
- [ ] Publish exam with questions â†’ Status updates to Active
- [ ] Delete draft exam â†’ Exam removed
- [ ] Try to delete published exam â†’ Error message

---

## Implementation Checklist

### Phase 1: Setup & Infrastructure âœ… (Completed)

- [x] Backend: Simplified Exam entity (removed duration, scheduling, access codes)
- [x] Backend: Created DTOs folder and centralized all DTOs
- [x] Backend: Fixed QueryHandlers to use userId from request
- [x] Backend: Applied database migration for simplified schema
- [x] Frontend: Updated TypeScript types to match backend
- [x] Frontend: Installed Shadcn components (dialog, form, table, card, button, input, select, badge, separator, tabs, sheet, sonner)

### Phase 2: Exam List & Creation ğŸ”„ (Ready to Implement)

- [ ] Install Shadcn components: `npx shadcn@latest add @shadcn/dialog @shadcn/form @shadcn/table @shadcn/card @shadcn/button @shadcn/input @shadcn/select @shadcn/badge @shadcn/separator @shadcn/tabs @shadcn/sheet @shadcn/sonner`
- [ ] Create folder structure: `src/features/exams/`
- [ ] Implement `useExams` hook with TanStack Query
- [ ] Implement `useSubjects` and `useTopics` hooks
- [ ] Create `examSchema.ts` with Zod validation
- [ ] Build `ExamList` component with table UI
- [ ] Build `CreateExamDialog` component with cascade loading
- [ ] Add routing: `/exams` page
- [ ] Test exam creation flow end-to-end
- [ ] Verify query invalidation and cache updates

### Phase 3: Question Bank ğŸ”„ (Ready to Implement)

- [ ] Implement `useQuestions` hook with optimistic updates
- [ ] Create `questionSchema.ts` with dynamic validation
- [ ] Build `QuestionBank` component with filters
- [ ] Build `QuestionForm` component with dynamic answer fields
- [ ] Implement question creation with success/error feedback
- [ ] Implement question editing with pre-populated form
- [ ] Implement question deletion with confirmation dialog
- [ ] Add routing: `/questions` page
- [ ] Test question CRUD operations
- [ ] Verify optimistic updates and rollback on error

### Phase 4: Exam Detail & Question Association ğŸ”„ (Ready to Implement)

- [ ] Create `ExamDetailPage` component
- [ ] Build `ExamQuestionList` component (reorderable)
- [ ] Build `QuestionSelector` dialog for adding questions
- [ ] Implement add questions to exam mutation
- [ ] Implement remove question from exam mutation
- [ ] Implement drag-and-drop reordering (use `dnd-kit` library)
- [ ] Add routing: `/exams/:id` page
- [ ] Test question association flow
- [ ] Verify real-time updates when adding/removing questions

### Phase 5: Matrix Builder (Optional) ğŸ”„ (Ready to Implement)

- [ ] Create `matrixSchema.ts` with validation
- [ ] Build `MatrixBuilder` component with dynamic rows
- [ ] Implement auto-calculation for totals and weights
- [ ] Implement matrix saving mutation
- [ ] Add matrix fulfillment status UI in QuestionSelector
- [ ] Highlight questions that fulfill matrix requirements
- [ ] Test matrix creation and validation
- [ ] Verify matrix persistence in database

### Phase 6: Publish Exam Workflow ğŸ”„ (Ready to Implement)

- [ ] Build `PublishExamButton` component with validation
- [ ] Implement `usePublishExam` mutation
- [ ] Add pre-publish validation (at least 1 question)
- [ ] Show confirmation dialog before publishing
- [ ] Update status badge after publish
- [ ] Disable editing for published exams (optional)
- [ ] Test publish flow with valid/invalid exams
- [ ] Verify domain event is raised on backend

### Phase 7: Testing & Refinement ğŸ”„ (After Implementation)

- [ ] Write unit tests for all components
- [ ] Write integration tests for mutations
- [ ] Perform cross-browser testing (Chrome, Firefox, Safari)
- [ ] Test responsive design on mobile devices
- [ ] Verify accessibility (keyboard navigation, screen readers)
- [ ] Performance audit (bundle size, lazy loading)
- [ ] Security audit (XSS prevention, CSRF protection)
- [ ] User acceptance testing with sample teachers

### Phase 8: Documentation & Deployment ğŸ”„ (After Testing)

- [ ] Update API documentation (Swagger/OpenAPI)
- [ ] Write user guide for teachers
- [ ] Create video tutorial for exam creation flow
- [ ] Update README.md with feature descriptions
- [ ] Perform final code review
- [ ] Deploy to staging environment
- [ ] Smoke test on staging
- [ ] Deploy to production

---

## Acceptance Criteria Summary

**Feature is considered complete when:**

- âœ… All checkboxes in Implementation Checklist are marked `[x]`
- âœ… All user stories have acceptance criteria met
- âœ… Unit tests pass with 80%+ coverage
- âœ… Integration tests pass for all CRUD operations
- âœ… Manual testing checklist completed without critical bugs
- âœ… Responsive design works on mobile, tablet, desktop
- âœ… Accessibility audit passes (WCAG 2.1 Level AA)
- âœ… Performance: Initial load < 2s, Time to Interactive < 3s
- âœ… Error handling: All API errors display user-friendly messages
- âœ… Security: No XSS, CSRF, or authentication bypass vulnerabilities
- âœ… Documentation: User guide and API docs updated

---

## Notes & Considerations

### UX Considerations

- **Progressive Disclosure:** Show only essential fields initially, expand advanced options on demand
- **Inline Help:** Tooltips and help text explain complex concepts (e.g., Bloom's taxonomy)
- **Keyboard Shortcuts:** Power users can navigate with keyboard (e.g., Ctrl+N for new exam)
- **Bulk Actions:** Allow selecting multiple questions and adding them all at once

### Performance Optimizations

- **Lazy Loading:** Route-based code splitting for exam/question pages
- **Virtual Scrolling:** For large question lists (100+ questions)
- **Debounced Search:** Wait 300ms after user stops typing before filtering
- **Optimistic Updates:** Immediate UI feedback for create/delete actions

### Accessibility

- **ARIA Labels:** All interactive elements have descriptive labels
- **Focus Management:** Dialogs trap focus, return focus on close
- **Keyboard Navigation:** All actions accessible via keyboard
- **Screen Reader Support:** Proper heading hierarchy, landmark regions

### Internationalization

- **Translation Keys:** All UI text uses i18next keys (e.g., `exams.create.title`)
- **Date Formatting:** Use locale-aware date formatting
- **Number Formatting:** Respect locale for numbers (e.g., 1,000 vs 1.000)

### Future Enhancements (Out of Scope for v1)

- Exam templates (save common exam structures for reuse)
- Question versioning (track changes to questions over time)
- Collaborative editing (multiple teachers co-create exams)
- AI-assisted question generation (separate feature)
- Import questions from file (CSV, Excel)
- Export exams to PDF (separate feature)

---

## Approval & Sign-Off

**Before proceeding to implementation, this spec must be reviewed and approved by:**

- [ ] Product Owner (Business Requirements)
- [ ] Tech Lead (Architecture & Patterns)
- [ ] UX Designer (UI/UX Consistency)
- [ ] QA Lead (Testability & Acceptance Criteria)

**Approval Date:** **\*\***\_\_\_**\*\***  
**Approved By:** **\*\***\_\_\_**\*\***

---

## LFG Trigger ğŸš€

**Once this spec is approved and all reviewers have signed off, implementation may begin.**

To start implementation, issue the command:

```
LFG
```

Then proceed with Phase 2 of the Implementation Checklist.

---

**End of Technical Specification**
